<%- layout('layout/boilerplate') %>
<div class="container py-4">
  <h1 class="h3 mb-4"><i class="fas fa-seedling me-2"></i>Fertilizer Recommendation</h1>

  <div class="row g-4">
    <div class="col-12 col-lg-5">
      <div class="card shadow-sm">
        <div class="card-header d-flex justify-content-between align-items-center">
          <strong>Input Parameters</strong>
          <button id="btnUseLocation" class="btn btn-sm btn-outline-primary"><i class="fas fa-location-arrow"></i> Use my location</button>
        </div>
        <div class="card-body">
          <form id="fertForm">
            <div class="mb-3">
              <label class="form-label">Crop <span class="text-danger">*</span></label>
              <input type="text" class="form-control" id="crop" name="crop" placeholder="e.g., Tomato" required>
            </div>
            <div class="mb-3">
              <label class="form-label">Soil Type <span class="text-danger">*</span></label>
              <select class="form-select" id="soil_type" name="soil_type" required>
                <option value="">Select Soil Type</option>
                <option value="sandy">Sandy</option>
                <option value="loamy">Loamy</option>
                <option value="clay">Clay</option>
                <option value="silt">Silt</option>
                <option value="peaty">Peaty</option>
                <option value="chalky">Chalky</option>
                <option value="black">Black</option>
                <option value="red">Red</option>
                <option value="alluvial">Alluvial</option>
              </select>
            </div>
            <div class="mb-3">
              <label class="form-label">Soil pH</label>
              <input type="number" class="form-control" id="ph" name="ph" min="0" max="14" step="0.1" placeholder="e.g., 6.8">
            </div>
            <div class="mb-3">
              <label class="form-label">Region</label>
              <input type="text" class="form-control" id="region" name="region" placeholder="e.g., Pune, Maharashtra">
            </div>
            <div class="mb-3">
              <label class="form-label">Average Temperature (°C)</label>
              <input type="number" class="form-control" id="temperature" name="temperature" min="0" max="50" step="0.1" placeholder="e.g., 28">
            </div>
            <div class="d-flex gap-2">
              <button type="submit" class="btn btn-primary">Get Plan</button>
              <button type="reset" class="btn btn-secondary" id="btnReset">Reset</button>
            </div>
          </form>
        </div>
      </div>
    </div>

    <div class="col-12 col-lg-7">
      <div id="loading" class="d-none text-center py-5">
        <div class="spinner-border text-primary" role="status"><span class="visually-hidden">Loading...</span></div>
        <p class="mt-3">Preparing crop-specific fertilizer schedule...</p>
      </div>

      <div id="result" class="d-none">
        <div class="card shadow-sm mb-3">
          <div class="card-header d-flex justify-content-between align-items-center">
            <strong>Recommended Schedule</strong>
            <button id="btnDownload" class="btn btn-sm btn-outline-secondary"><i class="fas fa-download"></i> Download PDF</button>
          </div>
          <div class="card-body">
            <div class="mb-2"><strong>Crop:</strong> <span id="rCrop"></span></div>
            <div class="mb-2"><strong>Totals:</strong> <span id="rTotals"></span></div>
            <div class="table-responsive">
              <table class="table table-bordered">
                <thead>
                  <tr><th>Stage</th><th>Recommendations</th></tr>
                </thead>
                <tbody id="rSchedule"></tbody>
              </table>
            </div>
            <div class="row">
              <div class="col-md-6">
                <h6>Assumptions</h6>
                <ul id="rAssumptions" class="small"></ul>
              </div>
              <div class="col-md-6">
                <h6>Risks</h6>
                <ul id="rRisks" class="small"></ul>
              </div>
            </div>
            <div class="mt-2">
              <h6>Next Actions</h6>
              <ul id="rNext" class="small"></ul>
            </div>
          </div>
        </div>
      </div>

      <div id="empty" class="alert alert-warning d-none">No plan returned. Adjust inputs and try again.</div>
    </div>
  </div>
</div>

<script>
(function() {
  const form = document.getElementById('fertForm');
  const loading = document.getElementById('loading');
  const result = document.getElementById('result');
  const empty = document.getElementById('empty');
  const rCrop = document.getElementById('rCrop');
  const rTotals = document.getElementById('rTotals');
  const rSchedule = document.getElementById('rSchedule');
  const rAssumptions = document.getElementById('rAssumptions');
  const rRisks = document.getElementById('rRisks');
  const rNext = document.getElementById('rNext');
  const btnDownload = document.getElementById('btnDownload');

  // Prefill from localStorage
  const saved = JSON.parse(localStorage.getItem('fertInputs') || '{}');
  ['crop','soil_type','ph','region','temperature'].forEach(k => { if (saved[k]) document.getElementById(k).value = saved[k]; });

  form.addEventListener('submit', async (e) => {
    e.preventDefault();
    loading.classList.remove('d-none');
    result.classList.add('d-none');
    empty.classList.add('d-none');

    const body = {
      crop: document.getElementById('crop').value.trim(),
      soil_type: document.getElementById('soil_type').value,
      ph: document.getElementById('ph').value,
      region: document.getElementById('region').value,
      temperature: document.getElementById('temperature').value
    };

    // Save inputs
    localStorage.setItem('fertInputs', JSON.stringify(body));

    try {
      const resp = await fetch('/api/fertilizer/recommend', {
        method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(body)
      });
      const data = await resp.json();
      loading.classList.add('d-none');
      if (!data.success) { empty.classList.remove('d-none'); return; }

      // Render
      rCrop.textContent = data.crop;
      const t = data.totals || {};
      rTotals.textContent = `N: ${t.N || '—'}  P: ${t.P || '—'}  K: ${t.K || '—'}`;
      rSchedule.innerHTML = (data.schedule || []).map(s => `<tr><td>${s.stage}</td><td>${s.recommendations}</td></tr>`).join('');
      rAssumptions.innerHTML = (data.assumptions || []).map(a => `<li>${a}</li>`).join('');
      rRisks.innerHTML = (data.risks || []).map(a => `<li>${a}</li>`).join('');
      rNext.innerHTML = (data.next_actions || []).map(a => `<li>${a}</li>`).join('');
      result.classList.remove('d-none');
    } catch (err) {
      loading.classList.add('d-none');
      empty.classList.remove('d-none');
      console.error('Fertilizer fetch error', err);
    }
  });

  document.getElementById('btnReset').addEventListener('click', () => {
    localStorage.removeItem('fertInputs');
  });

  // Use my location → fill temperature via /api/weather
  document.getElementById('btnUseLocation').addEventListener('click', () => {
    if (!navigator.geolocation) return alert('Geolocation not supported');
    navigator.geolocation.getCurrentPosition(async (pos) => {
      try {
        const { latitude: lat, longitude: lon } = pos.coords;
        const url = `/api/weather?lat=${lat}&lon=${lon}&units=metric`;
        const resp = await fetch(url);
        const data = await resp.json();
        if (data && (data.data || data).temp) {
          const temp = (data.data?.temp ?? data.temp);
          document.getElementById('temperature').value = temp;
        }
      } catch (e) { console.warn('Weather fetch failed', e); }
    }, () => alert('Unable to get location'));
  });
})();
</script>
